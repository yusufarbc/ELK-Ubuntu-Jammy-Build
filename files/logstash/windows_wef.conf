###############################################################################
# Windows Event Forwarding (WEF) → Winlogbeat → Logstash Pipeline
# - Winlogbeat, WEF Collector sunucusunda Windows Event Log'ları okuyup
#   Logstash'e (Beats protokolü) gönderir.
# - Bu pipeline 0.0.0.0:5045 üzerinde dinler.
# - Filtreler ve çıkış, SADECE Winlogbeat olaylarına uygulanır
#   (if [agent][type] == "winlogbeat") → diğer pipeline’larla çakışma yok.
# - Elasticsearch bağlantısı TLS + CA ile güvenlidir.
# - Parola düz metin değil; Logstash keystore (ES_PW) kullanılır.
###############################################################################

############################
# INPUT
############################
input {
  beats {
    host => "0.0.0.0"
    port => 5045

    # --- İsteğe Bağlı: Beats→Logstash TLS (agent ile karşılıklı TLS isterseniz) ---
    # ssl => true
    # ssl_certificate => "/etc/logstash/certs/wef_input.crt"
    # ssl_key         => "/etc/logstash/certs/wef_input.key"
  }
}

############################
# FILTER
############################
filter {
  # Bu blok SADECE Winlogbeat gönderilerini işler
  if [agent][type] == "winlogbeat" {
    # Kullanışlı etiketler
    mutate { add_tag => ["wef","windows","winlogbeat"] }

    # Bazı temel alan normalizasyonları (Winlogbeat zaten ECS uyumlu veri yollar)
    mutate {
      convert => { "[event][code]" => "integer" }
      copy    => {
        "[winlog][computer_name]" => "[host][name]"
        "[winlog][channel]"       => "[event][module]"
        "[winlog][provider_name]" => "[event][provider]"
      }
    }

    # Kaynak event zamanı mevcutsa @timestamp üzerine yaz (tutarlılık için)
    if [winlog][time_created] {
      date {
        match  => ["[winlog][time_created]", "ISO8601"]
        target => "@timestamp"
      }
    }

    # Sık görülen event ID’leri için basit bir eylem adı eşlemesi (örnek)
    translate {
      field       => "[event][code]"
      destination => "[event][action]"
      dictionary  => {
        "4624" "logon_success"
        "4625" "logon_failed"
        "4634" "logoff"
        "4648" "logon_explicit_credentials"
        "4688" "process_created"
        "4720" "user_created"
        "4726" "user_deleted"
        "4740" "account_locked"
        "4768" "kerberos_tgt_requested"
        "4769" "kerberos_service_ticket"
      }
      fallback => "wef_event"
    }

    # Gürültü azaltma (isteğe bağlı örnekler):
    # if [event][code] in [5145] { drop { } }             # çok gürültülü paylaşım olayları
    # if "NoiseSource" in [winlog][provider_name] { drop { } }
  }
}

############################
# OUTPUT
############################
output {
  # SADECE Winlogbeat olaylarını ES'e yaz
  if [agent][type] == "winlogbeat" {
    elasticsearch {
      hosts    => ["https://localhost:9200"]
      index    => "wef-windows-events-%{+YYYY.MM.dd}"
      user     => "logstash_ingest"
      password => "${ES_PW}"                       # Logstash keystore’dan okunur
      ssl      => true
      cacert   => "/etc/elasticsearch/certs/ca.crt"
    }

    # Hata ayıklama için aç/kapat:
    # stdout { codec => rubydebug }
  }
}